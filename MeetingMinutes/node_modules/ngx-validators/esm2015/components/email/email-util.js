/*
 * Code fromMailcheck https://github.com/mailcheck/mailcheck
 * Author
 * Derrick Ko (@derrickko)
 *
 * Released under the MIT License.
 *
 * v 1.1.2
 */
export class EmailSuggestion {
    constructor() {
        this.defaultOptions = {
            domains: [
                "msn.com",
                "bellsouth.net",
                "telus.net",
                "comcast.net",
                "optusnet.com.au",
                "earthlink.net",
                "qq.com",
                "sky.com",
                "icloud.com",
                "mac.com",
                "sympatico.ca",
                "googlemail.com",
                "att.net",
                "xtra.co.nz",
                "web.de",
                "cox.net",
                "gmail.com",
                "ymail.com",
                "yahoo.com",
                "aim.com",
                "rogers.com",
                "verizon.net",
                "rocketmail.com",
                "google.com",
                "optonline.net",
                "sbcglobal.net",
                "aol.com",
                "me.com",
                "btinternet.com",
                "charter.net",
                "shaw.ca",
            ],
            secondLevelDomains: ["yahoo", "hotmail", "mail", "live", "outlook", "gmx"],
            topLevelDomains: [
                "com",
                "com.au",
                "com.tw",
                "ca",
                "co.nz",
                "co.uk",
                "de",
                "fr",
                "it",
                "ru",
                "net",
                "org",
                "edu",
                "gov",
                "jp",
                "nl",
                "kr",
                "se",
                "eu",
                "ie",
                "co.il",
                "us",
                "at",
                "be",
                "dk",
                "hk",
                "es",
                "gr",
                "ch",
                "no",
                "cz",
                "in",
                "net",
                "net.au",
                "info",
                "biz",
                "mil",
                "co.jp",
                "sg",
                "hu",
                "uk",
            ],
        };
    }
    suggest(email, options) {
        let opt = this.defaultOptions;
        if (options !== undefined) {
            opt = options;
        }
        const emailParts = this.splitEmail(email.toLowerCase());
        if (!emailParts) {
            return undefined;
        }
        if (opt.secondLevelDomains && opt.topLevelDomains) {
            // If the email is a valid 2nd-level + top-level, do not suggest anything.
            if (opt.secondLevelDomains.indexOf(emailParts.secondLevelDomain) !== -1 &&
                opt.topLevelDomains.indexOf(emailParts.topLevelDomain) !== -1) {
                return undefined;
            }
        }
        let closestDomain = this.findClosestDomain(emailParts.domain, opt.domains, 2);
        if (closestDomain) {
            if (closestDomain === emailParts.domain) {
                // The email address exactly matches one of the supplied domains; do not return a suggestion.
                return undefined;
            }
            else {
                // The email address closely matches one of the supplied domains; return a suggestion
                return {
                    suggestion: {
                        address: emailParts.address,
                        domain: closestDomain,
                        full: emailParts.address + "@" + closestDomain,
                    },
                };
            }
        }
        const closestSecondLevelDomain = this.findClosestDomain(emailParts.secondLevelDomain, opt.secondLevelDomains, 2);
        const closestTopLevelDomain = this.findClosestDomain(emailParts.topLevelDomain, opt.topLevelDomains, 2);
        if (emailParts.domain) {
            closestDomain = emailParts.domain;
            let rtrn = false;
            if (closestSecondLevelDomain && closestSecondLevelDomain !== emailParts.secondLevelDomain) {
                // The email address may have a mispelled second-level domain; return a suggestion
                closestDomain = closestDomain.replace(emailParts.secondLevelDomain, closestSecondLevelDomain);
                rtrn = true;
            }
            if (closestTopLevelDomain &&
                closestTopLevelDomain !== emailParts.topLevelDomain &&
                emailParts.secondLevelDomain !== "") {
                // The email address may have a mispelled top-level domain; return a suggestion
                closestDomain = closestDomain.replace(new RegExp(emailParts.topLevelDomain + "$"), closestTopLevelDomain);
                rtrn = true;
            }
            if (rtrn) {
                return {
                    suggestion: {
                        address: emailParts.address,
                        domain: closestDomain,
                        full: emailParts.address + "@" + closestDomain,
                    },
                };
            }
        }
        /* The email address exactly matches one of the supplied domains, does not closely
         * match any domain and does not appear to simply have a mispelled top-level domain,
         * or is an invalid email address; do not return a suggestion.
         */
        return undefined;
    }
    splitEmail(email) {
        const parts = email.trim().split("@");
        if (parts.length < 2) {
            return undefined;
        }
        // tslint:disable-next-line: prefer-for-of
        for (let i = 0; i < parts.length; i++) {
            if (parts[i] === "") {
                return undefined;
            }
        }
        const result = {
            topLevelDomain: "",
            secondLevelDomain: "",
            domain: parts.pop(),
            address: "",
        };
        const domainParts = result.domain.split(".");
        if (domainParts.length === 0) {
            return undefined;
        }
        else if (domainParts.length === 1) {
            result.topLevelDomain = domainParts[0];
        }
        else {
            // The address has a domain and a top-level domain
            result.secondLevelDomain = domainParts[0];
            for (let j = 1; j < domainParts.length; j++) {
                result.topLevelDomain += domainParts[j] + ".";
            }
            result.topLevelDomain = result.topLevelDomain.substring(0, result.topLevelDomain.length - 1);
        }
        result.address = parts.join("@");
        return result;
    }
    findClosestDomain(domain, domains, threshold) {
        let dist;
        let minDist = Infinity;
        let closestDomain = null;
        if (!domain || !domains) {
            return undefined;
        }
        // tslint:disable-next-line: prefer-for-of
        for (let i = 0; i < domains.length; i++) {
            if (domain === domains[i]) {
                return domain;
            }
            dist = this.sift4Distance(domain, domains[i], 5);
            if (dist < minDist) {
                minDist = dist;
                closestDomain = domains[i];
            }
        }
        if (minDist <= threshold && closestDomain !== null) {
            return closestDomain;
        }
        else {
            return undefined;
        }
    }
    sift4Distance(s1, s2, maxOffset) {
        // sift4: https://siderite.blogspot.com/2014/11/super-fast-and-accurate-string-distance.html
        if (maxOffset === undefined) {
            maxOffset = 5; // default
        }
        if (!s1 || !s1.length) {
            if (!s2) {
                return 0;
            }
            return s2.length;
        }
        if (!s2 || !s2.length) {
            return s1.length;
        }
        const l1 = s1.length;
        const l2 = s2.length;
        let c1 = 0; // cursor for string 1
        let c2 = 0; // cursor for string 2
        let lcss = 0; // largest common subsequence
        let localCS = 0; // local common substring
        let trans = 0; // number of transpositions ('ab' vs 'ba')
        const offsetArr = []; // offset pair array, for computing the transpositions
        while (c1 < l1 && c2 < l2) {
            if (s1.charAt(c1) === s2.charAt(c2)) {
                localCS++;
                let isTrans = false;
                // see if current match is a transposition
                let i = 0;
                while (i < offsetArr.length) {
                    const ofs = offsetArr[i];
                    if (c1 <= ofs.c1 || c2 <= ofs.c2) {
                        // when two matches cross, the one considered a transposition is the one with the largest difference in offsets
                        isTrans = Math.abs(c2 - c1) >= Math.abs(ofs.c2 - ofs.c1);
                        if (isTrans) {
                            trans++;
                        }
                        else {
                            if (!ofs.trans) {
                                ofs.trans = true;
                                trans++;
                            }
                        }
                        break;
                    }
                    else {
                        if (c1 > ofs.c2 && c2 > ofs.c1) {
                            offsetArr.splice(i, 1);
                        }
                        else {
                            i++;
                        }
                    }
                }
                offsetArr.push({
                    c1,
                    c2,
                    trans: isTrans,
                });
            }
            else {
                lcss += localCS;
                localCS = 0;
                if (c1 !== c2) {
                    c1 = c2 = Math.min(c1, c2); // using min allows the computation of transpositions
                }
                // if matching characters are found, remove 1 from both cursors (they get incremented at the end of the loop)
                // so that we can have only one code block handling matches
                for (let j = 0; j < maxOffset && (c1 + j < l1 || c2 + j < l2); j++) {
                    if (c1 + j < l1 && s1.charAt(c1 + j) === s2.charAt(c2)) {
                        c1 += j - 1;
                        c2--;
                        break;
                    }
                    if (c2 + j < l2 && s1.charAt(c1) === s2.charAt(c2 + j)) {
                        c1--;
                        c2 += j - 1;
                        break;
                    }
                }
            }
            c1++;
            c2++;
            // this covers the case where the last match is on the last token in list, so that it can compute transpositions correctly
            if (c1 >= l1 || c2 >= l2) {
                lcss += localCS;
                localCS = 0;
                c1 = c2 = Math.min(c1, c2);
            }
        }
        lcss += localCS;
        return Math.round(Math.max(l1, l2) - lcss + trans); // add the cost of transpositions to the final result
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1haWwtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC12YWxpZGF0b3JzLyIsInNvdXJjZXMiOlsiY29tcG9uZW50cy9lbWFpbC9lbWFpbC11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztHQVFHO0FBMkJILE1BQU0sT0FBTyxlQUFlO0lBQTVCO1FBQ1UsbUJBQWMsR0FBaUI7WUFDckMsT0FBTyxFQUFFO2dCQUNQLFNBQVM7Z0JBQ1QsZUFBZTtnQkFDZixXQUFXO2dCQUNYLGFBQWE7Z0JBQ2IsaUJBQWlCO2dCQUNqQixlQUFlO2dCQUNmLFFBQVE7Z0JBQ1IsU0FBUztnQkFDVCxZQUFZO2dCQUNaLFNBQVM7Z0JBQ1QsY0FBYztnQkFDZCxnQkFBZ0I7Z0JBQ2hCLFNBQVM7Z0JBQ1QsWUFBWTtnQkFDWixRQUFRO2dCQUNSLFNBQVM7Z0JBQ1QsV0FBVztnQkFDWCxXQUFXO2dCQUNYLFdBQVc7Z0JBQ1gsU0FBUztnQkFDVCxZQUFZO2dCQUNaLGFBQWE7Z0JBQ2IsZ0JBQWdCO2dCQUNoQixZQUFZO2dCQUNaLGVBQWU7Z0JBQ2YsZUFBZTtnQkFDZixTQUFTO2dCQUNULFFBQVE7Z0JBQ1IsZ0JBQWdCO2dCQUNoQixhQUFhO2dCQUNiLFNBQVM7YUFDVjtZQUNELGtCQUFrQixFQUFFLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDMUUsZUFBZSxFQUFFO2dCQUNmLEtBQUs7Z0JBQ0wsUUFBUTtnQkFDUixRQUFRO2dCQUNSLElBQUk7Z0JBQ0osT0FBTztnQkFDUCxPQUFPO2dCQUNQLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osS0FBSztnQkFDTCxLQUFLO2dCQUNMLEtBQUs7Z0JBQ0wsS0FBSztnQkFDTCxJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixP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RjtZQUNELEVBQUUsRUFBRSxDQUFDO1lBQ0wsRUFBRSxFQUFFLENBQUM7WUFDTCwwSEFBMEg7WUFDMUgsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ3hCLElBQUksSUFBSSxPQUFPLENBQUM7Z0JBQ2hCLE9BQU8sR0FBRyxDQUFDLENBQUM7Z0JBQ1osRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUM1QjtTQUNGO1FBQ0QsSUFBSSxJQUFJLE9BQU8sQ0FBQztRQUNoQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMscURBQXFEO0lBQzNHLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb2RlIGZyb21NYWlsY2hlY2sgaHR0cHM6Ly9naXRodWIuY29tL21haWxjaGVjay9tYWlsY2hlY2tcbiAqIEF1dGhvclxuICogRGVycmljayBLbyAoQGRlcnJpY2trbylcbiAqXG4gKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4gKlxuICogdiAxLjEuMlxuICovXG5cbmV4cG9ydCBpbnRlcmZhY2UgRW1haWxPcHRpb25zIHtcbiAgZG9tYWluczogc3RyaW5nW107XG4gIHNlY29uZExldmVsRG9tYWluczogc3RyaW5nW107XG4gIHRvcExldmVsRG9tYWluczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BsaXR0ZWRFbWFpbCB7XG4gIHRvcExldmVsRG9tYWluOiBzdHJpbmc7XG4gIHNlY29uZExldmVsRG9tYWluOiBzdHJpbmc7XG4gIGRvbWFpbjogc3RyaW5nO1xuICBhZGRyZXNzOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3VnZ2VzdGlvbiB7XG4gIGFkZHJlc3M6IHN0cmluZztcbiAgZG9tYWluOiBzdHJpbmc7XG4gIGZ1bGw6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE9mZnNldCB7XG4gIGMxOiBudW1iZXI7XG4gIGMyOiBudW1iZXI7XG4gIHRyYW5zOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgRW1haWxTdWdnZXN0aW9uIHtcbiAgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogRW1haWxPcHRpb25zID0ge1xuICAgIGRvbWFpbnM6IFtcbiAgICAgIFwibXNuLmNvbVwiLFxuICAgICAgXCJiZWxsc291dGgubmV0XCIsXG4gICAgICBcInRlbHVzLm5ldFwiLFxuICAgICAgXCJjb21jYXN0Lm5ldFwiLFxuICAgICAgXCJvcHR1c25ldC5jb20uYXVcIixcbiAgICAgIFwiZWFydGhsaW5rLm5ldFwiLFxuICAgICAgXCJxcS5jb21cIixcbiAgICAgIFwic2t5LmNvbVwiLFxuICAgICAgXCJpY2xvdWQuY29tXCIsXG4gICAgICBcIm1hYy5jb21cIixcbiAgICAgIFwic3ltcGF0aWNvLmNhXCIsXG4gICAgICBcImdvb2dsZW1haWwuY29tXCIsXG4gICAgICBcImF0dC5uZXRcIixcbiAgICAgIFwieHRyYS5jby5uelwiLFxuICAgICAgXCJ3ZWIuZGVcIixcbiAgICAgIFwiY294Lm5ldFwiLFxuICAgICAgXCJnbWFpbC5jb21cIixcbiAgICAgIFwieW1haWwuY29tXCIsXG4gICAgICBcInlhaG9vLmNvbVwiLFxuICAgICAgXCJhaW0uY29tXCIsXG4gICAgICBcInJvZ2Vycy5jb21cIixcbiAgICAgIFwidmVyaXpvbi5uZXRcIixcbiAgICAgIFwicm9ja2V0bWFpbC5jb21cIixcbiAgICAgIFwiZ29vZ2xlLmNvbVwiLFxuICAgICAgXCJvcHRvbmxpbmUubmV0XCIsXG4gICAgICBcInNiY2dsb2JhbC5uZXRcIixcbiAgICAgIFwiYW9sLmNvbVwiLFxuICAgICAgXCJtZS5jb21cIixcbiAgICAgIFwiYnRpbnRlcm5ldC5jb21cIixcbiAgICAgIFwiY2hhcnRlci5uZXRcIixcbiAgICAgIFwic2hhdy5jYVwiLFxuICAgIF0sXG4gICAgc2Vjb25kTGV2ZWxEb21haW5zOiBbXCJ5YWhvb1wiLCBcImhvdG1haWxcIiwgXCJtYWlsXCIsIFwibGl2ZVwiLCBcIm91dGxvb2tcIiwgXCJnbXhcIl0sXG4gICAgdG9wTGV2ZWxEb21haW5zOiBbXG4gICAgICBcImNvbVwiLFxuICAgICAgXCJjb20uYXVcIixcbiAgICAgIFwiY29tLnR3XCIsXG4gICAgICBcImNhXCIsXG4gICAgICBcImNvLm56XCIsXG4gICAgICBcImNvLnVrXCIsXG4gICAgICBcImRlXCIsXG4gICAgICBcImZyXCIsXG4gICAgICBcIml0XCIsXG4gICAgICBcInJ1XCIsXG4gICAgICBcIm5ldFwiLFxuICAgICAgXCJvcmdcIixcbiAgICAgIFwiZWR1XCIsXG4gICAgICBcImdvdlwiLFxuICAgICAgXCJqcFwiLFxuICAgICAgXCJubFwiLFxuICAgICAgXCJrclwiLFxuICAgICAgXCJzZVwiLFxuICAgICAgXCJldVwiLFxuICAgICAgXCJpZVwiLFxuICAgICAgXCJjby5pbFwiLFxuICAgICAgXCJ1c1wiLFxuICAgICAgXCJhdFwiLFxuICAgICAgXCJiZVwiLFxuICAgICAgXCJka1wiLFxuICAgICAgXCJoa1wiLFxuICAgICAgXCJlc1wiLFxuICAgICAgXCJnclwiLFxuICAgICAgXCJjaFwiLFxuICAgICAgXCJub1wiLFxuICAgICAgXCJjelwiLFxuICAgICAgXCJpblwiLFxuICAgICAgXCJuZXRcIixcbiAgICAgIFwibmV0LmF1XCIsXG4gICAgICBcImluZm9cIixcbiAgICAgIFwiYml6XCIsXG4gICAgICBcIm1pbFwiLFxuICAgICAgXCJjby5qcFwiLFxuICAgICAgXCJzZ1wiLFxuICAgICAgXCJodVwiLFxuICAgICAgXCJ1a1wiLFxuICAgIF0sXG4gIH07XG5cbiAgcHVibGljIHN1Z2dlc3QoZW1haWw6IHN0cmluZywgb3B0aW9ucz86IEVtYWlsT3B0aW9ucyk6IHsgW2tleTogc3RyaW5nXTogU3VnZ2VzdGlvbiB9IHtcbiAgICBsZXQgb3B0ID0gdGhpcy5kZWZhdWx0T3B0aW9ucztcbiAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHQgPSBvcHRpb25zO1xuICAgIH1cbiAgICBjb25zdCBlbWFpbFBhcnRzID0gdGhpcy5zcGxpdEVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgaWYgKCFlbWFpbFBhcnRzKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmIChvcHQuc2Vjb25kTGV2ZWxEb21haW5zICYmIG9wdC50b3BMZXZlbERvbWFpbnMpIHtcbiAgICAgIC8vIElmIHRoZSBlbWFpbCBpcyBhIHZhbGlkIDJuZC1sZXZlbCArIHRvcC1sZXZlbCwgZG8gbm90IHN1Z2dlc3QgYW55dGhpbmcuXG4gICAgICBpZiAoXG4gICAgICAgIG9wdC5zZWNvbmRMZXZlbERvbWFpbnMuaW5kZXhPZihlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSAhPT0gLTEgJiZcbiAgICAgICAgb3B0LnRvcExldmVsRG9tYWlucy5pbmRleE9mKGVtYWlsUGFydHMudG9wTGV2ZWxEb21haW4pICE9PSAtMVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGNsb3Nlc3REb21haW4gPSB0aGlzLmZpbmRDbG9zZXN0RG9tYWluKGVtYWlsUGFydHMuZG9tYWluLCBvcHQuZG9tYWlucywgMik7XG4gICAgaWYgKGNsb3Nlc3REb21haW4pIHtcbiAgICAgIGlmIChjbG9zZXN0RG9tYWluID09PSBlbWFpbFBhcnRzLmRvbWFpbikge1xuICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRoZSBlbWFpbCBhZGRyZXNzIGNsb3NlbHkgbWF0Y2hlcyBvbmUgb2YgdGhlIHN1cHBsaWVkIGRvbWFpbnM7IHJldHVybiBhIHN1Z2dlc3Rpb25cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWdnZXN0aW9uOiB7XG4gICAgICAgICAgICBhZGRyZXNzOiBlbWFpbFBhcnRzLmFkZHJlc3MsXG4gICAgICAgICAgICBkb21haW46IGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgICBmdWxsOiBlbWFpbFBhcnRzLmFkZHJlc3MgKyBcIkBcIiArIGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gPSB0aGlzLmZpbmRDbG9zZXN0RG9tYWluKGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4sIG9wdC5zZWNvbmRMZXZlbERvbWFpbnMsIDIpO1xuICAgIGNvbnN0IGNsb3Nlc3RUb3BMZXZlbERvbWFpbiA9IHRoaXMuZmluZENsb3Nlc3REb21haW4oZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbiwgb3B0LnRvcExldmVsRG9tYWlucywgMik7XG5cbiAgICBpZiAoZW1haWxQYXJ0cy5kb21haW4pIHtcbiAgICAgIGNsb3Nlc3REb21haW4gPSBlbWFpbFBhcnRzLmRvbWFpbjtcbiAgICAgIGxldCBydHJuID0gZmFsc2U7XG5cbiAgICAgIGlmIChjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gJiYgY2xvc2VzdFNlY29uZExldmVsRG9tYWluICE9PSBlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSB7XG4gICAgICAgIC8vIFRoZSBlbWFpbCBhZGRyZXNzIG1heSBoYXZlIGEgbWlzcGVsbGVkIHNlY29uZC1sZXZlbCBkb21haW47IHJldHVybiBhIHN1Z2dlc3Rpb25cbiAgICAgICAgY2xvc2VzdERvbWFpbiA9IGNsb3Nlc3REb21haW4ucmVwbGFjZShlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluLCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4pO1xuICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBjbG9zZXN0VG9wTGV2ZWxEb21haW4gJiZcbiAgICAgICAgY2xvc2VzdFRvcExldmVsRG9tYWluICE9PSBlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICYmXG4gICAgICAgIGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4gIT09IFwiXCJcbiAgICAgICkge1xuICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBtYXkgaGF2ZSBhIG1pc3BlbGxlZCB0b3AtbGV2ZWwgZG9tYWluOyByZXR1cm4gYSBzdWdnZXN0aW9uXG4gICAgICAgIGNsb3Nlc3REb21haW4gPSBjbG9zZXN0RG9tYWluLnJlcGxhY2UobmV3IFJlZ0V4cChlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICsgXCIkXCIpLCBjbG9zZXN0VG9wTGV2ZWxEb21haW4pO1xuICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJ0cm4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWdnZXN0aW9uOiB7XG4gICAgICAgICAgICBhZGRyZXNzOiBlbWFpbFBhcnRzLmFkZHJlc3MsXG4gICAgICAgICAgICBkb21haW46IGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgICBmdWxsOiBlbWFpbFBhcnRzLmFkZHJlc3MgKyBcIkBcIiArIGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKiBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zLCBkb2VzIG5vdCBjbG9zZWx5XG4gICAgICogbWF0Y2ggYW55IGRvbWFpbiBhbmQgZG9lcyBub3QgYXBwZWFyIHRvIHNpbXBseSBoYXZlIGEgbWlzcGVsbGVkIHRvcC1sZXZlbCBkb21haW4sXG4gICAgICogb3IgaXMgYW4gaW52YWxpZCBlbWFpbCBhZGRyZXNzOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgKi9cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIHNwbGl0RW1haWwoZW1haWw6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcnRzID0gZW1haWwudHJpbSgpLnNwbGl0KFwiQFwiKTtcblxuICAgIGlmIChwYXJ0cy5sZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogcHJlZmVyLWZvci1vZlxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChwYXJ0c1tpXSA9PT0gXCJcIikge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIHRvcExldmVsRG9tYWluOiBcIlwiLFxuICAgICAgc2Vjb25kTGV2ZWxEb21haW46IFwiXCIsXG4gICAgICBkb21haW46IHBhcnRzLnBvcCgpLFxuICAgICAgYWRkcmVzczogXCJcIixcbiAgICB9O1xuXG4gICAgY29uc3QgZG9tYWluUGFydHMgPSByZXN1bHQuZG9tYWluLnNwbGl0KFwiLlwiKTtcblxuICAgIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiA9IGRvbWFpblBhcnRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUaGUgYWRkcmVzcyBoYXMgYSBkb21haW4gYW5kIGEgdG9wLWxldmVsIGRvbWFpblxuICAgICAgcmVzdWx0LnNlY29uZExldmVsRG9tYWluID0gZG9tYWluUGFydHNbMF07XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IGRvbWFpblBhcnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiArPSBkb21haW5QYXJ0c1tqXSArIFwiLlwiO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnRvcExldmVsRG9tYWluID0gcmVzdWx0LnRvcExldmVsRG9tYWluLnN1YnN0cmluZygwLCByZXN1bHQudG9wTGV2ZWxEb21haW4ubGVuZ3RoIC0gMSk7XG4gICAgfVxuXG4gICAgcmVzdWx0LmFkZHJlc3MgPSBwYXJ0cy5qb2luKFwiQFwiKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRDbG9zZXN0RG9tYWluKGRvbWFpbjogc3RyaW5nLCBkb21haW5zOiBzdHJpbmdbXSwgdGhyZXNob2xkOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGxldCBkaXN0O1xuICAgIGxldCBtaW5EaXN0ID0gSW5maW5pdHk7XG4gICAgbGV0IGNsb3Nlc3REb21haW4gPSBudWxsO1xuXG4gICAgaWYgKCFkb21haW4gfHwgIWRvbWFpbnMpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZm9yLW9mXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkb21haW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoZG9tYWluID09PSBkb21haW5zW2ldKSB7XG4gICAgICAgIHJldHVybiBkb21haW47XG4gICAgICB9XG4gICAgICBkaXN0ID0gdGhpcy5zaWZ0NERpc3RhbmNlKGRvbWFpbiwgZG9tYWluc1tpXSwgNSk7XG4gICAgICBpZiAoZGlzdCA8IG1pbkRpc3QpIHtcbiAgICAgICAgbWluRGlzdCA9IGRpc3Q7XG4gICAgICAgIGNsb3Nlc3REb21haW4gPSBkb21haW5zW2ldO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChtaW5EaXN0IDw9IHRocmVzaG9sZCAmJiBjbG9zZXN0RG9tYWluICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2xvc2VzdERvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNpZnQ0RGlzdGFuY2UoczE6IHN0cmluZywgczI6IHN0cmluZywgbWF4T2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIHNpZnQ0OiBodHRwczovL3NpZGVyaXRlLmJsb2dzcG90LmNvbS8yMDE0LzExL3N1cGVyLWZhc3QtYW5kLWFjY3VyYXRlLXN0cmluZy1kaXN0YW5jZS5odG1sXG4gICAgaWYgKG1heE9mZnNldCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtYXhPZmZzZXQgPSA1OyAvLyBkZWZhdWx0XG4gICAgfVxuXG4gICAgaWYgKCFzMSB8fCAhczEubGVuZ3RoKSB7XG4gICAgICBpZiAoIXMyKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHMyLmxlbmd0aDtcbiAgICB9XG5cbiAgICBpZiAoIXMyIHx8ICFzMi5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBzMS5sZW5ndGg7XG4gICAgfVxuXG4gICAgY29uc3QgbDEgPSBzMS5sZW5ndGg7XG4gICAgY29uc3QgbDIgPSBzMi5sZW5ndGg7XG5cbiAgICBsZXQgYzEgPSAwOyAvLyBjdXJzb3IgZm9yIHN0cmluZyAxXG4gICAgbGV0IGMyID0gMDsgLy8gY3Vyc29yIGZvciBzdHJpbmcgMlxuICAgIGxldCBsY3NzID0gMDsgLy8gbGFyZ2VzdCBjb21tb24gc3Vic2VxdWVuY2VcbiAgICBsZXQgbG9jYWxDUyA9IDA7IC8vIGxvY2FsIGNvbW1vbiBzdWJzdHJpbmdcbiAgICBsZXQgdHJhbnMgPSAwOyAvLyBudW1iZXIgb2YgdHJhbnNwb3NpdGlvbnMgKCdhYicgdnMgJ2JhJylcbiAgICBjb25zdCBvZmZzZXRBcnI6IE9mZnNldFtdID0gW107IC8vIG9mZnNldCBwYWlyIGFycmF5LCBmb3IgY29tcHV0aW5nIHRoZSB0cmFuc3Bvc2l0aW9uc1xuXG4gICAgd2hpbGUgKGMxIDwgbDEgJiYgYzIgPCBsMikge1xuICAgICAgaWYgKHMxLmNoYXJBdChjMSkgPT09IHMyLmNoYXJBdChjMikpIHtcbiAgICAgICAgbG9jYWxDUysrO1xuICAgICAgICBsZXQgaXNUcmFucyA9IGZhbHNlO1xuICAgICAgICAvLyBzZWUgaWYgY3VycmVudCBtYXRjaCBpcyBhIHRyYW5zcG9zaXRpb25cbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICB3aGlsZSAoaSA8IG9mZnNldEFyci5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBvZnMgPSBvZmZzZXRBcnJbaV07XG4gICAgICAgICAgaWYgKGMxIDw9IG9mcy5jMSB8fCBjMiA8PSBvZnMuYzIpIHtcbiAgICAgICAgICAgIC8vIHdoZW4gdHdvIG1hdGNoZXMgY3Jvc3MsIHRoZSBvbmUgY29uc2lkZXJlZCBhIHRyYW5zcG9zaXRpb24gaXMgdGhlIG9uZSB3aXRoIHRoZSBsYXJnZXN0IGRpZmZlcmVuY2UgaW4gb2Zmc2V0c1xuICAgICAgICAgICAgaXNUcmFucyA9IE1hdGguYWJzKGMyIC0gYzEpID49IE1hdGguYWJzKG9mcy5jMiAtIG9mcy5jMSk7XG4gICAgICAgICAgICBpZiAoaXNUcmFucykge1xuICAgICAgICAgICAgICB0cmFucysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKCFvZnMudHJhbnMpIHtcbiAgICAgICAgICAgICAgICBvZnMudHJhbnMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRyYW5zKys7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoYzEgPiBvZnMuYzIgJiYgYzIgPiBvZnMuYzEpIHtcbiAgICAgICAgICAgICAgb2Zmc2V0QXJyLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgb2Zmc2V0QXJyLnB1c2goe1xuICAgICAgICAgIGMxLFxuICAgICAgICAgIGMyLFxuICAgICAgICAgIHRyYW5zOiBpc1RyYW5zLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxjc3MgKz0gbG9jYWxDUztcbiAgICAgICAgbG9jYWxDUyA9IDA7XG4gICAgICAgIGlmIChjMSAhPT0gYzIpIHtcbiAgICAgICAgICBjMSA9IGMyID0gTWF0aC5taW4oYzEsIGMyKTsgLy8gdXNpbmcgbWluIGFsbG93cyB0aGUgY29tcHV0YXRpb24gb2YgdHJhbnNwb3NpdGlvbnNcbiAgICAgICAgfVxuICAgICAgICAvLyBpZiBtYXRjaGluZyBjaGFyYWN0ZXJzIGFyZSBmb3VuZCwgcmVtb3ZlIDEgZnJvbSBib3RoIGN1cnNvcnMgKHRoZXkgZ2V0IGluY3JlbWVudGVkIGF0IHRoZSBlbmQgb2YgdGhlIGxvb3ApXG4gICAgICAgIC8vIHNvIHRoYXQgd2UgY2FuIGhhdmUgb25seSBvbmUgY29kZSBibG9jayBoYW5kbGluZyBtYXRjaGVzXG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWF4T2Zmc2V0ICYmIChjMSArIGogPCBsMSB8fCBjMiArIGogPCBsMik7IGorKykge1xuICAgICAgICAgIGlmIChjMSArIGogPCBsMSAmJiBzMS5jaGFyQXQoYzEgKyBqKSA9PT0gczIuY2hhckF0KGMyKSkge1xuICAgICAgICAgICAgYzEgKz0gaiAtIDE7XG4gICAgICAgICAgICBjMi0tO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjMiArIGogPCBsMiAmJiBzMS5jaGFyQXQoYzEpID09PSBzMi5jaGFyQXQoYzIgKyBqKSkge1xuICAgICAgICAgICAgYzEtLTtcbiAgICAgICAgICAgIGMyICs9IGogLSAxO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjMSsrO1xuICAgICAgYzIrKztcbiAgICAgIC8vIHRoaXMgY292ZXJzIHRoZSBjYXNlIHdoZXJlIHRoZSBsYXN0IG1hdGNoIGlzIG9uIHRoZSBsYXN0IHRva2VuIGluIGxpc3QsIHNvIHRoYXQgaXQgY2FuIGNvbXB1dGUgdHJhbnNwb3NpdGlvbnMgY29ycmVjdGx5XG4gICAgICBpZiAoYzEgPj0gbDEgfHwgYzIgPj0gbDIpIHtcbiAgICAgICAgbGNzcyArPSBsb2NhbENTO1xuICAgICAgICBsb2NhbENTID0gMDtcbiAgICAgICAgYzEgPSBjMiA9IE1hdGgubWluKGMxLCBjMik7XG4gICAgICB9XG4gICAgfVxuICAgIGxjc3MgKz0gbG9jYWxDUztcbiAgICByZXR1cm4gTWF0aC5yb3VuZChNYXRoLm1heChsMSwgbDIpIC0gbGNzcyArIHRyYW5zKTsgLy8gYWRkIHRoZSBjb3N0IG9mIHRyYW5zcG9zaXRpb25zIHRvIHRoZSBmaW5hbCByZXN1bHRcbiAgfVxufVxuIl19