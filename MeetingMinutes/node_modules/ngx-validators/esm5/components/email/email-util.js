/*
 * Code fromMailcheck https://github.com/mailcheck/mailcheck
 * Author
 * Derrick Ko (@derrickko)
 *
 * Released under the MIT License.
 *
 * v 1.1.2
 */
var EmailSuggestion = /** @class */ (function () {
    function EmailSuggestion() {
        this.defaultOptions = {
            domains: [
                "msn.com",
                "bellsouth.net",
                "telus.net",
                "comcast.net",
                "optusnet.com.au",
                "earthlink.net",
                "qq.com",
                "sky.com",
                "icloud.com",
                "mac.com",
                "sympatico.ca",
                "googlemail.com",
                "att.net",
                "xtra.co.nz",
                "web.de",
                "cox.net",
                "gmail.com",
                "ymail.com",
                "yahoo.com",
                "aim.com",
                "rogers.com",
                "verizon.net",
                "rocketmail.com",
                "google.com",
                "optonline.net",
                "sbcglobal.net",
                "aol.com",
                "me.com",
                "btinternet.com",
                "charter.net",
                "shaw.ca",
            ],
            secondLevelDomains: ["yahoo", "hotmail", "mail", "live", "outlook", "gmx"],
            topLevelDomains: [
                "com",
                "com.au",
                "com.tw",
                "ca",
                "co.nz",
                "co.uk",
                "de",
                "fr",
                "it",
                "ru",
                "net",
                "org",
                "edu",
                "gov",
                "jp",
                "nl",
                "kr",
                "se",
                "eu",
                "ie",
                "co.il",
                "us",
                "at",
                "be",
                "dk",
                "hk",
                "es",
                "gr",
                "ch",
                "no",
                "cz",
                "in",
                "net",
                "net.au",
                "info",
                "biz",
                "mil",
                "co.jp",
                "sg",
                "hu",
                "uk",
            ],
        };
    }
    EmailSuggestion.prototype.suggest = function (email, options) {
        var opt = this.defaultOptions;
        if (options !== undefined) {
            opt = options;
        }
        var emailParts = this.splitEmail(email.toLowerCase());
        if (!emailParts) {
            return undefined;
        }
        if (opt.secondLevelDomains && opt.topLevelDomains) {
            // If the email is a valid 2nd-level + top-level, do not suggest anything.
            if (opt.secondLevelDomains.indexOf(emailParts.secondLevelDomain) !== -1 &&
                opt.topLevelDomains.indexOf(emailParts.topLevelDomain) !== -1) {
                return undefined;
            }
        }
        var closestDomain = this.findClosestDomain(emailParts.domain, opt.domains, 2);
        if (closestDomain) {
            if (closestDomain === emailParts.domain) {
                // The email address exactly matches one of the supplied domains; do not return a suggestion.
                return undefined;
            }
            else {
                // The email address closely matches one of the supplied domains; return a suggestion
                return {
                    suggestion: {
                        address: emailParts.address,
                        domain: closestDomain,
                        full: emailParts.address + "@" + closestDomain,
                    },
                };
            }
        }
        var closestSecondLevelDomain = this.findClosestDomain(emailParts.secondLevelDomain, opt.secondLevelDomains, 2);
        var closestTopLevelDomain = this.findClosestDomain(emailParts.topLevelDomain, opt.topLevelDomains, 2);
        if (emailParts.domain) {
            closestDomain = emailParts.domain;
            var rtrn = false;
            if (closestSecondLevelDomain && closestSecondLevelDomain !== emailParts.secondLevelDomain) {
                // The email address may have a mispelled second-level domain; return a suggestion
                closestDomain = closestDomain.replace(emailParts.secondLevelDomain, closestSecondLevelDomain);
                rtrn = true;
            }
            if (closestTopLevelDomain &&
                closestTopLevelDomain !== emailParts.topLevelDomain &&
                emailParts.secondLevelDomain !== "") {
                // The email address may have a mispelled top-level domain; return a suggestion
                closestDomain = closestDomain.replace(new RegExp(emailParts.topLevelDomain + "$"), closestTopLevelDomain);
                rtrn = true;
            }
            if (rtrn) {
                return {
                    suggestion: {
                        address: emailParts.address,
                        domain: closestDomain,
                        full: emailParts.address + "@" + closestDomain,
                    },
                };
            }
        }
        /* The email address exactly matches one of the supplied domains, does not closely
         * match any domain and does not appear to simply have a mispelled top-level domain,
         * or is an invalid email address; do not return a suggestion.
         */
        return undefined;
    };
    EmailSuggestion.prototype.splitEmail = function (email) {
        var parts = email.trim().split("@");
        if (parts.length < 2) {
            return undefined;
        }
        // tslint:disable-next-line: prefer-for-of
        for (var i = 0; i < parts.length; i++) {
            if (parts[i] === "") {
                return undefined;
            }
        }
        var result = {
            topLevelDomain: "",
            secondLevelDomain: "",
            domain: parts.pop(),
            address: "",
        };
        var domainParts = result.domain.split(".");
        if (domainParts.length === 0) {
            return undefined;
        }
        else if (domainParts.length === 1) {
            result.topLevelDomain = domainParts[0];
        }
        else {
            // The address has a domain and a top-level domain
            result.secondLevelDomain = domainParts[0];
            for (var j = 1; j < domainParts.length; j++) {
                result.topLevelDomain += domainParts[j] + ".";
            }
            result.topLevelDomain = result.topLevelDomain.substring(0, result.topLevelDomain.length - 1);
        }
        result.address = parts.join("@");
        return result;
    };
    EmailSuggestion.prototype.findClosestDomain = function (domain, domains, threshold) {
        var dist;
        var minDist = Infinity;
        var closestDomain = null;
        if (!domain || !domains) {
            return undefined;
        }
        // tslint:disable-next-line: prefer-for-of
        for (var i = 0; i < domains.length; i++) {
            if (domain === domains[i]) {
                return domain;
            }
            dist = this.sift4Distance(domain, domains[i], 5);
            if (dist < minDist) {
                minDist = dist;
                closestDomain = domains[i];
            }
        }
        if (minDist <= threshold && closestDomain !== null) {
            return closestDomain;
        }
        else {
            return undefined;
        }
    };
    EmailSuggestion.prototype.sift4Distance = function (s1, s2, maxOffset) {
        // sift4: https://siderite.blogspot.com/2014/11/super-fast-and-accurate-string-distance.html
        if (maxOffset === undefined) {
            maxOffset = 5; // default
        }
        if (!s1 || !s1.length) {
            if (!s2) {
                return 0;
            }
            return s2.length;
        }
        if (!s2 || !s2.length) {
            return s1.length;
        }
        var l1 = s1.length;
        var l2 = s2.length;
        var c1 = 0; // cursor for string 1
        var c2 = 0; // cursor for string 2
        var lcss = 0; // largest common subsequence
        var localCS = 0; // local common substring
        var trans = 0; // number of transpositions ('ab' vs 'ba')
        var offsetArr = []; // offset pair array, for computing the transpositions
        while (c1 < l1 && c2 < l2) {
            if (s1.charAt(c1) === s2.charAt(c2)) {
                localCS++;
                var isTrans = false;
                // see if current match is a transposition
                var i = 0;
                while (i < offsetArr.length) {
                    var ofs = offsetArr[i];
                    if (c1 <= ofs.c1 || c2 <= ofs.c2) {
                        // when two matches cross, the one considered a transposition is the one with the largest difference in offsets
                        isTrans = Math.abs(c2 - c1) >= Math.abs(ofs.c2 - ofs.c1);
                        if (isTrans) {
                            trans++;
                        }
                        else {
                            if (!ofs.trans) {
                                ofs.trans = true;
                                trans++;
                            }
                        }
                        break;
                    }
                    else {
                        if (c1 > ofs.c2 && c2 > ofs.c1) {
                            offsetArr.splice(i, 1);
                        }
                        else {
                            i++;
                        }
                    }
                }
                offsetArr.push({
                    c1: c1,
                    c2: c2,
                    trans: isTrans,
                });
            }
            else {
                lcss += localCS;
                localCS = 0;
                if (c1 !== c2) {
                    c1 = c2 = Math.min(c1, c2); // using min allows the computation of transpositions
                }
                // if matching characters are found, remove 1 from both cursors (they get incremented at the end of the loop)
                // so that we can have only one code block handling matches
                for (var j = 0; j < maxOffset && (c1 + j < l1 || c2 + j < l2); j++) {
                    if (c1 + j < l1 && s1.charAt(c1 + j) === s2.charAt(c2)) {
                        c1 += j - 1;
                        c2--;
                        break;
                    }
                    if (c2 + j < l2 && s1.charAt(c1) === s2.charAt(c2 + j)) {
                        c1--;
                        c2 += j - 1;
                        break;
                    }
                }
            }
            c1++;
            c2++;
            // this covers the case where the last match is on the last token in list, so that it can compute transpositions correctly
            if (c1 >= l1 || c2 >= l2) {
                lcss += localCS;
                localCS = 0;
                c1 = c2 = Math.min(c1, c2);
            }
        }
        lcss += localCS;
        return Math.round(Math.max(l1, l2) - lcss + trans); // add the cost of transpositions to the final result
    };
    return EmailSuggestion;
}());
export { EmailSuggestion };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1haWwtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC12YWxpZGF0b3JzLyIsInNvdXJjZXMiOlsiY29tcG9uZW50cy9lbWFpbC9lbWFpbC11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztHQVFHO0FBMkJIO0lBQUE7UUFDVSxtQkFBYyxHQUFpQjtZQUNyQyxPQUFPLEVBQUU7Z0JBQ1AsU0FBUztnQkFDVCxlQUFlO2dCQUNmLFdBQVc7Z0JBQ1gsYUFBYTtnQkFDYixpQkFBaUI7Z0JBQ2pCLGVBQWU7Z0JBQ2YsUUFBUTtnQkFDUixTQUFTO2dCQUNULFlBQVk7Z0JBQ1osU0FBUztnQkFDVCxjQUFjO2dCQUNkLGdCQUFnQjtnQkFDaEIsU0FBUztnQkFDVCxZQUFZO2dCQUNaLFFBQVE7Z0JBQ1IsU0FBUztnQkFDVCxXQUFXO2dCQUNYLFdBQVc7Z0JBQ1gsV0FBVztnQkFDWCxTQUFTO2dCQUNULFlBQVk7Z0JBQ1osYUFBYTtnQkFDYixnQkFBZ0I7Z0JBQ2hCLFlBQVk7Z0JBQ1osZUFBZTtnQkFDZixlQUFlO2dCQUNmLFNBQVM7Z0JBQ1QsUUFBUTtnQkFDUixnQkFBZ0I7Z0JBQ2hCLGFBQWE7Z0JBQ2IsU0FBUzthQUNWO1lBQ0Qsa0JBQWtCLEVBQUUsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQztZQUMxRSxlQUFlLEVBQUU7Z0JBQ2YsS0FBSztnQkFDTCxRQUFRO2dCQUNSLFFBQVE7Z0JBQ1IsSUFBSTtnQkFDSixPQUFPO2dCQUNQLE9BQU87Z0JBQ1AsSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixLQUFLO2dCQUNMLEtBQUs7Z0JBQ0wsS0FBSztnQkFDTCxLQUFLO2dCQUNMLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixJQUFJO2dCQUNKLE9BQU87Z0JBQ1AsSUFBSTtn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Q1osTUFBTTtxQkFDUDtpQkFDRjthQUNGO1lBQ0QsRUFBRSxFQUFFLENBQUM7WUFDTCxFQUFFLEVBQUUsQ0FBQztZQUNMLDBIQUEwSDtZQUMxSCxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDeEIsSUFBSSxJQUFJLE9BQU8sQ0FBQztnQkFDaEIsT0FBTyxHQUFHLENBQUMsQ0FBQztnQkFDWixFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQzVCO1NBQ0Y7UUFDRCxJQUFJLElBQUksT0FBTyxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxxREFBcUQ7SUFDM0csQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQWxVRCxJQWtVQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb2RlIGZyb21NYWlsY2hlY2sgaHR0cHM6Ly9naXRodWIuY29tL21haWxjaGVjay9tYWlsY2hlY2tcbiAqIEF1dGhvclxuICogRGVycmljayBLbyAoQGRlcnJpY2trbylcbiAqXG4gKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4gKlxuICogdiAxLjEuMlxuICovXG5cbmV4cG9ydCBpbnRlcmZhY2UgRW1haWxPcHRpb25zIHtcbiAgZG9tYWluczogc3RyaW5nW107XG4gIHNlY29uZExldmVsRG9tYWluczogc3RyaW5nW107XG4gIHRvcExldmVsRG9tYWluczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BsaXR0ZWRFbWFpbCB7XG4gIHRvcExldmVsRG9tYWluOiBzdHJpbmc7XG4gIHNlY29uZExldmVsRG9tYWluOiBzdHJpbmc7XG4gIGRvbWFpbjogc3RyaW5nO1xuICBhZGRyZXNzOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3VnZ2VzdGlvbiB7XG4gIGFkZHJlc3M6IHN0cmluZztcbiAgZG9tYWluOiBzdHJpbmc7XG4gIGZ1bGw6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE9mZnNldCB7XG4gIGMxOiBudW1iZXI7XG4gIGMyOiBudW1iZXI7XG4gIHRyYW5zOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgRW1haWxTdWdnZXN0aW9uIHtcbiAgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogRW1haWxPcHRpb25zID0ge1xuICAgIGRvbWFpbnM6IFtcbiAgICAgIFwibXNuLmNvbVwiLFxuICAgICAgXCJiZWxsc291dGgubmV0XCIsXG4gICAgICBcInRlbHVzLm5ldFwiLFxuICAgICAgXCJjb21jYXN0Lm5ldFwiLFxuICAgICAgXCJvcHR1c25ldC5jb20uYXVcIixcbiAgICAgIFwiZWFydGhsaW5rLm5ldFwiLFxuICAgICAgXCJxcS5jb21cIixcbiAgICAgIFwic2t5LmNvbVwiLFxuICAgICAgXCJpY2xvdWQuY29tXCIsXG4gICAgICBcIm1hYy5jb21cIixcbiAgICAgIFwic3ltcGF0aWNvLmNhXCIsXG4gICAgICBcImdvb2dsZW1haWwuY29tXCIsXG4gICAgICBcImF0dC5uZXRcIixcbiAgICAgIFwieHRyYS5jby5uelwiLFxuICAgICAgXCJ3ZWIuZGVcIixcbiAgICAgIFwiY294Lm5ldFwiLFxuICAgICAgXCJnbWFpbC5jb21cIixcbiAgICAgIFwieW1haWwuY29tXCIsXG4gICAgICBcInlhaG9vLmNvbVwiLFxuICAgICAgXCJhaW0uY29tXCIsXG4gICAgICBcInJvZ2Vycy5jb21cIixcbiAgICAgIFwidmVyaXpvbi5uZXRcIixcbiAgICAgIFwicm9ja2V0bWFpbC5jb21cIixcbiAgICAgIFwiZ29vZ2xlLmNvbVwiLFxuICAgICAgXCJvcHRvbmxpbmUubmV0XCIsXG4gICAgICBcInNiY2dsb2JhbC5uZXRcIixcbiAgICAgIFwiYW9sLmNvbVwiLFxuICAgICAgXCJtZS5jb21cIixcbiAgICAgIFwiYnRpbnRlcm5ldC5jb21cIixcbiAgICAgIFwiY2hhcnRlci5uZXRcIixcbiAgICAgIFwic2hhdy5jYVwiLFxuICAgIF0sXG4gICAgc2Vjb25kTGV2ZWxEb21haW5zOiBbXCJ5YWhvb1wiLCBcImhvdG1haWxcIiwgXCJtYWlsXCIsIFwibGl2ZVwiLCBcIm91dGxvb2tcIiwgXCJnbXhcIl0sXG4gICAgdG9wTGV2ZWxEb21haW5zOiBbXG4gICAgICBcImNvbVwiLFxuICAgICAgXCJjb20uYXVcIixcbiAgICAgIFwiY29tLnR3XCIsXG4gICAgICBcImNhXCIsXG4gICAgICBcImNvLm56XCIsXG4gICAgICBcImNvLnVrXCIsXG4gICAgICBcImRlXCIsXG4gICAgICBcImZyXCIsXG4gICAgICBcIml0XCIsXG4gICAgICBcInJ1XCIsXG4gICAgICBcIm5ldFwiLFxuICAgICAgXCJvcmdcIixcbiAgICAgIFwiZWR1XCIsXG4gICAgICBcImdvdlwiLFxuICAgICAgXCJqcFwiLFxuICAgICAgXCJubFwiLFxuICAgICAgXCJrclwiLFxuICAgICAgXCJzZVwiLFxuICAgICAgXCJldVwiLFxuICAgICAgXCJpZVwiLFxuICAgICAgXCJjby5pbFwiLFxuICAgICAgXCJ1c1wiLFxuICAgICAgXCJhdFwiLFxuICAgICAgXCJiZVwiLFxuICAgICAgXCJka1wiLFxuICAgICAgXCJoa1wiLFxuICAgICAgXCJlc1wiLFxuICAgICAgXCJnclwiLFxuICAgICAgXCJjaFwiLFxuICAgICAgXCJub1wiLFxuICAgICAgXCJjelwiLFxuICAgICAgXCJpblwiLFxuICAgICAgXCJuZXRcIixcbiAgICAgIFwibmV0LmF1XCIsXG4gICAgICBcImluZm9cIixcbiAgICAgIFwiYml6XCIsXG4gICAgICBcIm1pbFwiLFxuICAgICAgXCJjby5qcFwiLFxuICAgICAgXCJzZ1wiLFxuICAgICAgXCJodVwiLFxuICAgICAgXCJ1a1wiLFxuICAgIF0sXG4gIH07XG5cbiAgcHVibGljIHN1Z2dlc3QoZW1haWw6IHN0cmluZywgb3B0aW9ucz86IEVtYWlsT3B0aW9ucyk6IHsgW2tleTogc3RyaW5nXTogU3VnZ2VzdGlvbiB9IHtcbiAgICBsZXQgb3B0ID0gdGhpcy5kZWZhdWx0T3B0aW9ucztcbiAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHQgPSBvcHRpb25zO1xuICAgIH1cbiAgICBjb25zdCBlbWFpbFBhcnRzID0gdGhpcy5zcGxpdEVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgaWYgKCFlbWFpbFBhcnRzKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmIChvcHQuc2Vjb25kTGV2ZWxEb21haW5zICYmIG9wdC50b3BMZXZlbERvbWFpbnMpIHtcbiAgICAgIC8vIElmIHRoZSBlbWFpbCBpcyBhIHZhbGlkIDJuZC1sZXZlbCArIHRvcC1sZXZlbCwgZG8gbm90IHN1Z2dlc3QgYW55dGhpbmcuXG4gICAgICBpZiAoXG4gICAgICAgIG9wdC5zZWNvbmRMZXZlbERvbWFpbnMuaW5kZXhPZihlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSAhPT0gLTEgJiZcbiAgICAgICAgb3B0LnRvcExldmVsRG9tYWlucy5pbmRleE9mKGVtYWlsUGFydHMudG9wTGV2ZWxEb21haW4pICE9PSAtMVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGNsb3Nlc3REb21haW4gPSB0aGlzLmZpbmRDbG9zZXN0RG9tYWluKGVtYWlsUGFydHMuZG9tYWluLCBvcHQuZG9tYWlucywgMik7XG4gICAgaWYgKGNsb3Nlc3REb21haW4pIHtcbiAgICAgIGlmIChjbG9zZXN0RG9tYWluID09PSBlbWFpbFBhcnRzLmRvbWFpbikge1xuICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRoZSBlbWFpbCBhZGRyZXNzIGNsb3NlbHkgbWF0Y2hlcyBvbmUgb2YgdGhlIHN1cHBsaWVkIGRvbWFpbnM7IHJldHVybiBhIHN1Z2dlc3Rpb25cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWdnZXN0aW9uOiB7XG4gICAgICAgICAgICBhZGRyZXNzOiBlbWFpbFBhcnRzLmFkZHJlc3MsXG4gICAgICAgICAgICBkb21haW46IGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgICBmdWxsOiBlbWFpbFBhcnRzLmFkZHJlc3MgKyBcIkBcIiArIGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gPSB0aGlzLmZpbmRDbG9zZXN0RG9tYWluKGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4sIG9wdC5zZWNvbmRMZXZlbERvbWFpbnMsIDIpO1xuICAgIGNvbnN0IGNsb3Nlc3RUb3BMZXZlbERvbWFpbiA9IHRoaXMuZmluZENsb3Nlc3REb21haW4oZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbiwgb3B0LnRvcExldmVsRG9tYWlucywgMik7XG5cbiAgICBpZiAoZW1haWxQYXJ0cy5kb21haW4pIHtcbiAgICAgIGNsb3Nlc3REb21haW4gPSBlbWFpbFBhcnRzLmRvbWFpbjtcbiAgICAgIGxldCBydHJuID0gZmFsc2U7XG5cbiAgICAgIGlmIChjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gJiYgY2xvc2VzdFNlY29uZExldmVsRG9tYWluICE9PSBlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSB7XG4gICAgICAgIC8vIFRoZSBlbWFpbCBhZGRyZXNzIG1heSBoYXZlIGEgbWlzcGVsbGVkIHNlY29uZC1sZXZlbCBkb21haW47IHJldHVybiBhIHN1Z2dlc3Rpb25cbiAgICAgICAgY2xvc2VzdERvbWFpbiA9IGNsb3Nlc3REb21haW4ucmVwbGFjZShlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluLCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4pO1xuICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBjbG9zZXN0VG9wTGV2ZWxEb21haW4gJiZcbiAgICAgICAgY2xvc2VzdFRvcExldmVsRG9tYWluICE9PSBlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICYmXG4gICAgICAgIGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4gIT09IFwiXCJcbiAgICAgICkge1xuICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBtYXkgaGF2ZSBhIG1pc3BlbGxlZCB0b3AtbGV2ZWwgZG9tYWluOyByZXR1cm4gYSBzdWdnZXN0aW9uXG4gICAgICAgIGNsb3Nlc3REb21haW4gPSBjbG9zZXN0RG9tYWluLnJlcGxhY2UobmV3IFJlZ0V4cChlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICsgXCIkXCIpLCBjbG9zZXN0VG9wTGV2ZWxEb21haW4pO1xuICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJ0cm4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWdnZXN0aW9uOiB7XG4gICAgICAgICAgICBhZGRyZXNzOiBlbWFpbFBhcnRzLmFkZHJlc3MsXG4gICAgICAgICAgICBkb21haW46IGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgICBmdWxsOiBlbWFpbFBhcnRzLmFkZHJlc3MgKyBcIkBcIiArIGNsb3Nlc3REb21haW4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKiBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zLCBkb2VzIG5vdCBjbG9zZWx5XG4gICAgICogbWF0Y2ggYW55IGRvbWFpbiBhbmQgZG9lcyBub3QgYXBwZWFyIHRvIHNpbXBseSBoYXZlIGEgbWlzcGVsbGVkIHRvcC1sZXZlbCBkb21haW4sXG4gICAgICogb3IgaXMgYW4gaW52YWxpZCBlbWFpbCBhZGRyZXNzOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgKi9cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIHNwbGl0RW1haWwoZW1haWw6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcnRzID0gZW1haWwudHJpbSgpLnNwbGl0KFwiQFwiKTtcblxuICAgIGlmIChwYXJ0cy5sZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogcHJlZmVyLWZvci1vZlxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChwYXJ0c1tpXSA9PT0gXCJcIikge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIHRvcExldmVsRG9tYWluOiBcIlwiLFxuICAgICAgc2Vjb25kTGV2ZWxEb21haW46IFwiXCIsXG4gICAgICBkb21haW46IHBhcnRzLnBvcCgpLFxuICAgICAgYWRkcmVzczogXCJcIixcbiAgICB9O1xuXG4gICAgY29uc3QgZG9tYWluUGFydHMgPSByZXN1bHQuZG9tYWluLnNwbGl0KFwiLlwiKTtcblxuICAgIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiA9IGRvbWFpblBhcnRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUaGUgYWRkcmVzcyBoYXMgYSBkb21haW4gYW5kIGEgdG9wLWxldmVsIGRvbWFpblxuICAgICAgcmVzdWx0LnNlY29uZExldmVsRG9tYWluID0gZG9tYWluUGFydHNbMF07XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IGRvbWFpblBhcnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiArPSBkb21haW5QYXJ0c1tqXSArIFwiLlwiO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnRvcExldmVsRG9tYWluID0gcmVzdWx0LnRvcExldmVsRG9tYWluLnN1YnN0cmluZygwLCByZXN1bHQudG9wTGV2ZWxEb21haW4ubGVuZ3RoIC0gMSk7XG4gICAgfVxuXG4gICAgcmVzdWx0LmFkZHJlc3MgPSBwYXJ0cy5qb2luKFwiQFwiKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRDbG9zZXN0RG9tYWluKGRvbWFpbjogc3RyaW5nLCBkb21haW5zOiBzdHJpbmdbXSwgdGhyZXNob2xkOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGxldCBkaXN0O1xuICAgIGxldCBtaW5EaXN0ID0gSW5maW5pdHk7XG4gICAgbGV0IGNsb3Nlc3REb21haW4gPSBudWxsO1xuXG4gICAgaWYgKCFkb21haW4gfHwgIWRvbWFpbnMpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZm9yLW9mXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkb21haW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoZG9tYWluID09PSBkb21haW5zW2ldKSB7XG4gICAgICAgIHJldHVybiBkb21haW47XG4gICAgICB9XG4gICAgICBkaXN0ID0gdGhpcy5zaWZ0NERpc3RhbmNlKGRvbWFpbiwgZG9tYWluc1tpXSwgNSk7XG4gICAgICBpZiAoZGlzdCA8IG1pbkRpc3QpIHtcbiAgICAgICAgbWluRGlzdCA9IGRpc3Q7XG4gICAgICAgIGNsb3Nlc3REb21haW4gPSBkb21haW5zW2ldO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChtaW5EaXN0IDw9IHRocmVzaG9sZCAmJiBjbG9zZXN0RG9tYWluICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2xvc2VzdERvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNpZnQ0RGlzdGFuY2UoczE6IHN0cmluZywgczI6IHN0cmluZywgbWF4T2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIHNpZnQ0OiBodHRwczovL3NpZGVyaXRlLmJsb2dzcG90LmNvbS8yMDE0LzExL3N1cGVyLWZhc3QtYW5kLWFjY3VyYXRlLXN0cmluZy1kaXN0YW5jZS5odG1sXG4gICAgaWYgKG1heE9mZnNldCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtYXhPZmZzZXQgPSA1OyAvLyBkZWZhdWx0XG4gICAgfVxuXG4gICAgaWYgKCFzMSB8fCAhczEubGVuZ3RoKSB7XG4gICAgICBpZiAoIXMyKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHMyLmxlbmd0aDtcbiAgICB9XG5cbiAgICBpZiAoIXMyIHx8ICFzMi5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBzMS5sZW5ndGg7XG4gICAgfVxuXG4gICAgY29uc3QgbDEgPSBzMS5sZW5ndGg7XG4gICAgY29uc3QgbDIgPSBzMi5sZW5ndGg7XG5cbiAgICBsZXQgYzEgPSAwOyAvLyBjdXJzb3IgZm9yIHN0cmluZyAxXG4gICAgbGV0IGMyID0gMDsgLy8gY3Vyc29yIGZvciBzdHJpbmcgMlxuICAgIGxldCBsY3NzID0gMDsgLy8gbGFyZ2VzdCBjb21tb24gc3Vic2VxdWVuY2VcbiAgICBsZXQgbG9jYWxDUyA9IDA7IC8vIGxvY2FsIGNvbW1vbiBzdWJzdHJpbmdcbiAgICBsZXQgdHJhbnMgPSAwOyAvLyBudW1iZXIgb2YgdHJhbnNwb3NpdGlvbnMgKCdhYicgdnMgJ2JhJylcbiAgICBjb25zdCBvZmZzZXRBcnI6IE9mZnNldFtdID0gW107IC8vIG9mZnNldCBwYWlyIGFycmF5LCBmb3IgY29tcHV0aW5nIHRoZSB0cmFuc3Bvc2l0aW9uc1xuXG4gICAgd2hpbGUgKGMxIDwgbDEgJiYgYzIgPCBsMikge1xuICAgICAgaWYgKHMxLmNoYXJBdChjMSkgPT09IHMyLmNoYXJBdChjMikpIHtcbiAgICAgICAgbG9jYWxDUysrO1xuICAgICAgICBsZXQgaXNUcmFucyA9IGZhbHNlO1xuICAgICAgICAvLyBzZWUgaWYgY3VycmVudCBtYXRjaCBpcyBhIHRyYW5zcG9zaXRpb25cbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICB3aGlsZSAoaSA8IG9mZnNldEFyci5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBvZnMgPSBvZmZzZXRBcnJbaV07XG4gICAgICAgICAgaWYgKGMxIDw9IG9mcy5jMSB8fCBjMiA8PSBvZnMuYzIpIHtcbiAgICAgICAgICAgIC8vIHdoZW4gdHdvIG1hdGNoZXMgY3Jvc3MsIHRoZSBvbmUgY29uc2lkZXJlZCBhIHRyYW5zcG9zaXRpb24gaXMgdGhlIG9uZSB3aXRoIHRoZSBsYXJnZXN0IGRpZmZlcmVuY2UgaW4gb2Zmc2V0c1xuICAgICAgICAgICAgaXNUcmFucyA9IE1hdGguYWJzKGMyIC0gYzEpID49IE1hdGguYWJzKG9mcy5jMiAtIG9mcy5jMSk7XG4gICAgICAgICAgICBpZiAoaXNUcmFucykge1xuICAgICAgICAgICAgICB0cmFucysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKCFvZnMudHJhbnMpIHtcbiAgICAgICAgICAgICAgICBvZnMudHJhbnMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRyYW5zKys7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoYzEgPiBvZnMuYzIgJiYgYzIgPiBvZnMuYzEpIHtcbiAgICAgICAgICAgICAgb2Zmc2V0QXJyLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgb2Zmc2V0QXJyLnB1c2goe1xuICAgICAgICAgIGMxLFxuICAgICAgICAgIGMyLFxuICAgICAgICAgIHRyYW5zOiBpc1RyYW5zLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxjc3MgKz0gbG9jYWxDUztcbiAgICAgICAgbG9jYWxDUyA9IDA7XG4gICAgICAgIGlmIChjMSAhPT0gYzIpIHtcbiAgICAgICAgICBjMSA9IGMyID0gTWF0aC5taW4oYzEsIGMyKTsgLy8gdXNpbmcgbWluIGFsbG93cyB0aGUgY29tcHV0YXRpb24gb2YgdHJhbnNwb3NpdGlvbnNcbiAgICAgICAgfVxuICAgICAgICAvLyBpZiBtYXRjaGluZyBjaGFyYWN0ZXJzIGFyZSBmb3VuZCwgcmVtb3ZlIDEgZnJvbSBib3RoIGN1cnNvcnMgKHRoZXkgZ2V0IGluY3JlbWVudGVkIGF0IHRoZSBlbmQgb2YgdGhlIGxvb3ApXG4gICAgICAgIC8vIHNvIHRoYXQgd2UgY2FuIGhhdmUgb25seSBvbmUgY29kZSBibG9jayBoYW5kbGluZyBtYXRjaGVzXG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWF4T2Zmc2V0ICYmIChjMSArIGogPCBsMSB8fCBjMiArIGogPCBsMik7IGorKykge1xuICAgICAgICAgIGlmIChjMSArIGogPCBsMSAmJiBzMS5jaGFyQXQoYzEgKyBqKSA9PT0gczIuY2hhckF0KGMyKSkge1xuICAgICAgICAgICAgYzEgKz0gaiAtIDE7XG4gICAgICAgICAgICBjMi0tO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjMiArIGogPCBsMiAmJiBzMS5jaGFyQXQoYzEpID09PSBzMi5jaGFyQXQoYzIgKyBqKSkge1xuICAgICAgICAgICAgYzEtLTtcbiAgICAgICAgICAgIGMyICs9IGogLSAxO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjMSsrO1xuICAgICAgYzIrKztcbiAgICAgIC8vIHRoaXMgY292ZXJzIHRoZSBjYXNlIHdoZXJlIHRoZSBsYXN0IG1hdGNoIGlzIG9uIHRoZSBsYXN0IHRva2VuIGluIGxpc3QsIHNvIHRoYXQgaXQgY2FuIGNvbXB1dGUgdHJhbnNwb3NpdGlvbnMgY29ycmVjdGx5XG4gICAgICBpZiAoYzEgPj0gbDEgfHwgYzIgPj0gbDIpIHtcbiAgICAgICAgbGNzcyArPSBsb2NhbENTO1xuICAgICAgICBsb2NhbENTID0gMDtcbiAgICAgICAgYzEgPSBjMiA9IE1hdGgubWluKGMxLCBjMik7XG4gICAgICB9XG4gICAgfVxuICAgIGxjc3MgKz0gbG9jYWxDUztcbiAgICByZXR1cm4gTWF0aC5yb3VuZChNYXRoLm1heChsMSwgbDIpIC0gbGNzcyArIHRyYW5zKTsgLy8gYWRkIHRoZSBjb3N0IG9mIHRyYW5zcG9zaXRpb25zIHRvIHRoZSBmaW5hbCByZXN1bHRcbiAgfVxufVxuIl19